<!DOCTYPE html>
<html>
    <!-- Will be a super, super casual & trippy rhythm game.-->
<head>
<title>ＴＲＩＰ.ＯＵＴ</title>
<style>
canvas {
    border: 1px solid #999999;
    margin: auto;
}
body {
    background-color: #000000;
}
#frameOutput {
    color: white;
}
</style>
<script>
var entities = [];
function init(){
    GAME.start();
    console.log("ayy lmao");
}
var GAME = {
    canvas: document.createElement("canvas"),
    start: function(){
        this.canvas.width = window.screen.width;
        this.canvas.height = window.screen.height;
        this.context = this.canvas.getContext("2d");
        document.body.insertBefore(this.canvas, document.body.childNodes[0]);
        this.frameCount = 0;
        this.interval = setInterval(draw, 20);
    },
    clear: function(){
        this.context.clearRect(0, 0, this.canvas.width, this.canvas.height);
    },
    gravity: 0.5,
    level: 1,
    date: new Date(),
}
GAME.initTime = GAME.date.getTime();
GAME.lastFrame = GAME.initTime;
function Entity(X, Y, width, height, type, STATIC, friction, gravity, color, text){
    this.position = {x: X, y: Y};
    this.width = width;
    this.height = height;
    this.velocity = {x: 0, y: 0};
    this.static = STATIC;
    this.friction = friction;
    this.gravity = gravity;
    this.color = color;
    this.text = text;
    this.draw = function(){
        CTX = GAME.context;
        CTX.fillStyle = this.color;
        if(!this.static){
            this.position.x += this.velocity.x;
            this.position.y += this.velocity.y;
            if(this.gravity){
                this.velocity.y += GAME.gravity;
            }
            if(this.friction){
                this.velocity.x *= 0.95;
                this.velocity.y *= 0.95;
            }
            //console.log(this.position.x);
        }
        if(this.text != undefined){
            CTX.font = this.width + " " + this.height;
            CTX.fillText(this.text, this.position.x, this.position.y);
        }
        switch(type){
            case "player":
                CTX.fillRect(this.position.x, this.position.y, this.width, this.height);
            break;
        }
    },
    this.applyForce = function(i, j){
        this.velocity.x += i;
        this.velocity.y += j;
    }
}
function Shape(X, Y, W, H, type, color, rotation, opacity, p1, p2, p3){
    this.position = {x: X, y: Y};
    this.width = W;
    this.height = H;
    this.color = color;
    this.type = type;
    this.rotation = rotation;
    this.opacity = opacity;
    this.p1 = p1; //Misc. Param. 1
    this.p2 = p2; //Misc. Param. 2
    this.p3 = p3;
    this.timer = 0;
    this.draw = function(){
        var CTX = GAME.context;
        CTX.fillStyle = this.color;
        CTX.save();
        CTX.translate(this.position.x, this.position.y);
        CTX.rotate(this.rotation * 2 * Math.PI/360);
        CTX.globalAlpha = this.opacity;
        switch(type){
            case "ellipse":
                CTX.beginPath();
                CTX.ellipse(0, 0, this.width, this.height, 0, 0, 2*Math.PI);
                CTX.fill();
                CTX.closePath();
            break;
            case "rect":
                CTX.fillRect(0 - this.width/2,
                            0 - this.height/2,
                            this.width,
                            this.height);
            break;
            case "rectFrame":
                CTX.fillRect(0 - this.width/2,
                            0 - this.height/2,
                            this.width - this.p1,
                            this.p1);
                CTX.fillRect(0 + this.width/2 - this.p1,
                            0 - this.height/2,
                            this.p1,
                            this.height - this.p1);
                CTX.fillRect(0 - this.width/2 + this.p1,
                            0 + this.height/2 - this.p1,
                            this.width - this.p1,
                            this.p1);
                CTX.fillRect(0 - this.width/2,
                            0 - this.height/2 + this.p1,
                            this.p1,
                            this.height - this.p1);
            break;
            case "line":
                CTX.beginPath();
                CTX.lineWidth = this.p1;
                CTX.strokeStyle = this.color;
                CTX.moveTo(0, 0);
                CTX.lineTo(this.width, this.height);
                CTX.stroke();
            break;
        }
        CTX.globalAlpha = 1;
        CTX.restore();
    }
}
function colorToList(color){
    return [
        parseInt(color.slice(1, 3), 16),
        parseInt(color.slice(3, 5), 16),
        parseInt(color.slice(5, 7), 16)];
}
function listToColor(color){
    return "#" + ("0"+(Number(color[0]).toString(16))).slice(-2).toUpperCase() +
                ("0"+(Number(color[1]).toString(16))).slice(-2).toUpperCase() +
                ("0"+(Number(color[2]).toString(16))).slice(-2).toUpperCase();
}
function lerpColor(c1, c2, progress){
    var color1 = colorToList(c1);
    var color2 = colorToList(c2);
    var p = Math.max(Math.min(progress, 1), 0);
    var returnColor = [0, 0, 0];
    for(var i = 0; i < color1.length; i++){
        returnColor[i] = Math.floor(color1[i] + p * (color2[i] - color1[i]));
    }
    return listToColor(returnColor);
}
function Note(X, Y, targetX, targetY, hitTime, key, startupLag=1000){
    this.position = {x: X, y: Y};
    this.target = {x: targetX, y: targetY};
    this.hitTime = hitTime;
    this.key = key;
}
var foregroundElements = [];
function drawElements(time){
    for(var i in foregroundElements){
        foregroundElements[i].draw(time);
    }
}
var backgroundElements = [];
var elementCounter = 0;
var backgroundState = Math.floor(Math.random() * 6) + 1;
var anim5MSFrameGap = 200;
//It's the nutshack
var bpm = 120;
var frameGap = Math.round(60/bpm * 1000);
var framesOfInterest = [frameGap * 1/12,
                        frameGap * 2/12,
                        frameGap * 3/12,
                        frameGap * 4/12,
                        frameGap * 5/12,
                        frameGap * 6/12,
                        frameGap * 7/12,
                        frameGap * 8/12,
                        frameGap * 9/12,
                        frameGap * 10/12,
                        frameGap * 11/12,
                        frameGap * 12/12,
                        frameGap * 1/8,
                        frameGap * 3/8,
                        frameGap * 5/8,
                        frameGap * 7/8, 0];
//It's nut the shack
function drawBackground(state, time, lastFrame){
    //console.log(time);
    //Shape Spawning
    switch(state){
        case 0:
            GAME.context.fillStyle = "red";
            GAME.context.fillRect(0, 0, GAME.canvas.width * ((time % 1000)/1000) ** 2, GAME.canvas.height);
        break;
        case 1:
            if(time % 500 < lastFrame % 500 && time != 0){
                var color;
                if(elementCounter % 2 == 0){
                    color = "#96ffae";
                }else{
                    color = "#fc1b84";
                }
                backgroundElements.push(new Shape(GAME.canvas.width/2, GAME.canvas.height/2, 0, 0, "ellipse", color, 0, 1));
                elementCounter++;
                //console.log("stuff pushed!");
            }
        break;
        case 2:
            if(time % 1000 < lastFrame % 1000 && time != 0){
                var color;
                backgroundElements.push(new Shape(GAME.canvas.width/2, GAME.canvas.height/2, 0, 0, "rectFrame", "#FF0000", 0, 1, 0));
                elementCounter++;
                //console.log("stuff pushed!");
            }
        break;
        case 3:
            GAME.context.fillStyle = lerpColor("#001122", "#552300", (time % 1600)/1600);
            GAME.context.fillRect(0, 0, GAME.canvas.width, GAME.canvas.height);
            if(time % 200 < lastFrame % 200 && time != 0){
                for(var i = 0; i < 3; i++){
                    backgroundElements.push(new Shape(GAME.canvas.width/2, GAME.canvas.height/2, 150, 150, "rect", "#FF0000", 0, 1, Math.random() * 2 * Math.PI, Math.random() * 10 - 5));
                }
            }
        break;
        case 4:
            GAME.context.lineCap = "round";
            if(time % 25 < lastFrame % 25 && time != 0){
                for(var i = 0; i < 3; i++){
                    var direction = Math.random() * 2 * Math.PI;
                    backgroundElements.push(new Shape(GAME.canvas.width/2, GAME.canvas.height/2, Math.sin(direction), Math.cos(direction), "line", "#FFFFFF", 0, 1, 1));
                }
            }
            if((time % 3200 < lastFrame % 3200 ||
                (time + 25) % 3200 < (lastFrame + 25) % 3200 ||
                (time + 50) % 3200 < (lastFrame + 50) % 3200)
                && time != 0){
                for(var i = 0; i < 16; i++){
                    var direction = i * Math.PI/8;
                    backgroundElements.push(new Shape(GAME.canvas.width/2, GAME.canvas.height/2, 1, 1, "ellipse", "#FFFFFF", 0, 1, direction));
                }
            }
        break;
        case 5:
            var invPeriod = 200;
            GAME.context.fillStyle = "#A1FC94";
            GAME.context.fillRect(GAME.canvas.width/2 - 150 * Math.sin(lastFrame),
                                    GAME.canvas.height/2 - 150 * Math.sin(lastFrame),
                                    300 * Math.sin(lastFrame),
                                    300 * Math.sin(lastFrame))
            if(time % anim5MSFrameGap < lastFrame % anim5MSFrameGap && time != 0){
                backgroundElements.push(new Shape(elementCounter % 51 - 100, GAME.canvas.height/2,
                50, GAME.canvas.height, "rect", "#92B2FC", 0, 1, 1));
                backgroundElements.push(new Shape(elementCounter % 51 - 100, (350 + 200 * Math.sin(time/invPeriod))/2,
                50, 350 + 200 * Math.sin(time/invPeriod), "rect", "#FC94EC", 0, 1, 1));
                backgroundElements.push(new Shape(elementCounter % 51 - 100, (700 + 200 * Math.sin(time/invPeriod))/2,
                50, 200, "rect", "#FCFC94", 0, 1, 1));
                elementCounter++;
            }
        break;
        case 6:
            GAME.context.lineCap = "round";
            var CTX = GAME.context;
            CTX.strokeStyle = "#FF00FF";
            for(var l = 0; l < GAME.canvas.height/2; l += 2){
                CTX.globalAlpha = 1;
                CTX.beginPath();
                CTX.lineWidth = 3;
                CTX.moveTo(0, (l ** 2)/2 + GAME.canvas.height/2);
                CTX.lineTo(GAME.canvas.width, (l ** 2)/2 + GAME.canvas.height/2);
                CTX.stroke();
                
                CTX.globalAlpha = 0.5;
                CTX.beginPath();
                CTX.lineWidth = 7;
                CTX.moveTo(0, (l ** 2)/2 + GAME.canvas.height/2);
                CTX.lineTo(GAME.canvas.width, (l ** 2)/2 + GAME.canvas.height/2);
                CTX.stroke();
                
                CTX.globalAlpha = 0.25;
                CTX.beginPath();
                CTX.lineWidth = 11;
                CTX.moveTo(0, (l ** 2)/2 + GAME.canvas.height/2);
                CTX.lineTo(GAME.canvas.width, (l ** 2)/2 + GAME.canvas.height/2);
                CTX.stroke();
            }
            if(time % 250 < lastFrame % 250 && time != 0){
                backgroundElements.push(new Shape(GAME.canvas.width, GAME.canvas.height/2, (GAME.canvas.width - GAME.canvas.width/2) * 1.1, GAME.canvas.height/2, "line", "#FF00FF", 0, 1, 3));
                backgroundElements.push(new Shape(GAME.canvas.width, GAME.canvas.height/2, (GAME.canvas.width - GAME.canvas.width/2) * 1.1, GAME.canvas.height/2, "line", "#FF00FF", 0, 0.5, 7));
                backgroundElements.push(new Shape(GAME.canvas.width, GAME.canvas.height/2, (GAME.canvas.width - GAME.canvas.width/2) * 1.1, GAME.canvas.height/2, "line", "#FF00FF", 0, 0.25, 11));
            }
            if(time % 125 < lastFrame % 125 && time != 0){
                var columnHeight = Math.random() * GAME.canvas.height/2;
                backgroundElements.push(new Shape(GAME.canvas.width + 25, GAME.canvas.height/2 - columnHeight/2, 50, columnHeight, "rect", lerpColor("#88FFFF", "#0000FF", Math.random()), 0, 1));
                backgroundElements.push(new Shape(GAME.canvas.width + 25, GAME.canvas.height/2 - columnHeight/2, 53, columnHeight, "rect", lerpColor("#88FFFF", "#0000FF", Math.random()), 0, 0.5));
                backgroundElements.push(new Shape(GAME.canvas.width + 25, GAME.canvas.height/2 - columnHeight/2, 56, columnHeight, "rect", lerpColor("#88FFFF", "#0000FF", Math.random()), 0, 0.25));
            }
        break;
    }
    for(var i = backgroundElements.length - 1; i >= 0; i--){
        var s = backgroundElements[i];
        switch(state){
            case 1:
                s.width += lastFrame/10;
                s.height += lastFrame/10;
                if(s.width > GAME.canvas.width ||
                s.height > GAME.canvas.height){
                    backgroundElements.splice(i, 1);
                }
            break;
            case 2:
                s.width += lastFrame/10;
                s.height += lastFrame/10;
                s.rotation += lastFrame/400;
                s.p1 = s.height/20;
                s.color = lerpColor("#FF0000", "#0000FF", s.width/GAME.canvas.width);
                if(s.width * 0.7 > GAME.canvas.width){
                    backgroundElements.splice(i, 1);
                }
            break;
            case 3:
                s.position.x += 2 * Math.cos(s.p1);
                s.position.y += 2 * Math.sin(s.p1);
                s.width *= 0.995;
                s.height *= 0.995;
                s.opacity *= 0.995;
                s.rotation += s.p2;
                s.color = lerpColor("#FFFF00", "#FF0000", (150 - s.width)/150);
                if(s.position.x > GAME.canvas.width ||
                s.position.y > GAME.canvas.height ||
                s.position.x + s.width * 0.7 < 0 ||
                s.position.y + s.height * 0.7 < 0 ||
                s.opacity <= 0){
                    backgroundElements.splice(i, 1);
                }
            break;
            case 4:
                if(s.type == "line"){
                    s.position.x += s.width/5;
                    s.position.y += s.height/5;
                    s.width *= 1.3;
                    s.height *= 1.3;
                    s.p1 *= 1.1;
                    if(s.position.x > GAME.canvas.width ||
                    s.position.y > GAME.canvas.height ||
                    s.position.x < 0 ||
                    s.position.y < 0 ||
                    s.opacity <= 0){
                        backgroundElements.splice(i, 1);
                    }
                }
                if(s.type == "ellipse"){
                    s.position.x += 40 * Math.cos(s.p1) * s.width/200;
                    s.position.y += 40 * Math.sin(s.p1) * s.width/200;
                    s.width *= 1.02;
                    s.height *= 1.02;
                    s.width = Math.min(s.width, 200);
                    s.height = Math.min(s.height, 200);
                    s.color = lerpColor("#96FFAE", "#FC1B84",
                    (Math.floor(s.width ** 2) % 255)/255);
                    if(s.position.x - s.width > GAME.canvas.width ||
                    s.position.y - s.height > GAME.canvas.height ||
                    s.position.x + s.width < 0 ||
                    s.position.y + s.height < 0 ||
                    s.opacity <= 0){
                        backgroundElements.splice(i, 1);
                    }
                }
            break;
            case 5:
                if(time % anim5MSFrameGap < lastFrame % anim5MSFrameGap && time != 0){
                    s.position.x += 102;
                    if(s.position.x > GAME.canvas.width){
                        backgroundElements.splice(i, 1);
                    }
                }
            break;
            case 6:
                s.position.x -= 5;
                if(s.type == "line"){
                    s.width = (s.position.x - GAME.canvas.width/2) * 1.1;
                }
                if(s.type == "rect"){
                    s.width = 50 - Math.abs(s.position.x - GAME.canvas.width/2) * 0.03;
                    s.position.x -= 8 * (s.height - GAME.canvas.height/2)/GAME.canvas.width;
                }
                if(s.position.x <= 0){
                    backgroundElements.splice(i, 1);
                }
            break;
        }
    }
    for(var i in backgroundElements){
        backgroundElements[i].draw();
    }
    if(time % anim5MSFrameGap < lastFrame % anim5MSFrameGap && time != 0 && backgroundState == 5){
        GAME.context.fillStyle = "black";
        GAME.context.fillRect(0, 0, GAME.canvas.width, GAME.canvas.height);
    }
    if(time % (anim5MSFrameGap * 4) < lastFrame % (anim5MSFrameGap * 4) && time != 0 && backgroundState == 5){
        GAME.context.fillStyle = "#00FF00";
        GAME.context.fillRect(0, 0, GAME.canvas.width, GAME.canvas.height);
    }
}
document.onkeydown = function(e){
    e = e || window.event;
    //var differenceFromBeat = Math.abs(Math.abs((GAME.date.getTime() - GAME.initTime) % 1000 - 500) - 500);
    //document.getElementById("frameOutput").innerHTML += ("<br>" + differenceFromBeat);
    var beatFrame = (GAME.date.getTime() - GAME.initTime) % frameGap;
    var onBeat = false;
    for(var i = 0; i < framesOfInterest.length; i++){
        console.log("B: " + framesOfInterest[i]);
        console.log("b: " + beatFrame);
        if(Math.abs(framesOfInterest[i] - beatFrame) <= 15 || Math.abs(framesOfInterest[i] - beatFrame) >= 975){
            onBeat = true;
        }
    }
    if(onBeat){
        //document.getElementById("frameOutput").innerHTML += "...<br>";
    }else{
        document.getElementById("frameOutput").innerHTML += "QWhfgfbhoqiwehflueiwhfli<br>";
    }
}
document.onkeyup = function(e){
    e = e || window.event;
}
function draw(){
    GAME.clear();
    GAME.date = new Date();
    drawBackground(backgroundState, GAME.date.getTime() - GAME.initTime,
                                    GAME.date.getTime() - GAME.lastFrame);
    for(var i in entities){
        entities[i].draw();
    }
    GAME.frameCount++;
    GAME.lastFrame = GAME.date.getTime();
}
</script>
</head>
<body onload="init()">
    <div id="frameOutput"></div>
</body>
</html>
